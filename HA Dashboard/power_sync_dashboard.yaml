title: PowerSync
views:
  - title: Energy Dashboard
    path: energy
    icon: mdi:lightning-bolt
    cards:
      - type: horizontal-stack
        cards:
          - type: gauge
            entity: sensor.current_import_price
            name: Import
            unit: $/kWh
            min: 0
            max: 0.6
            needle: true
            severity:
              green: 0
              yellow: 0.25
              red: 0.4
            card_mod:
              style: |
                ha-card {
                  height: 140px;
                }
          - type: gauge
            entity: sensor.current_export_price
            name: Export Earnings
            unit: $/kWh
            min: -0.1
            max: 0.3
            needle: true
            severity:
              red: -0.1
              yellow: 0
              green: 0.05
            card_mod:
              style: |
                ha-card {
                  height: 140px;
                }
          - type: gauge
            entity: sensor.battery_level
            name: Battery
            unit: '%'
            min: 0
            max: 100
            needle: true
            severity:
              red: 0
              yellow: 30
              green: 60
            card_mod:
              style: |
                ha-card {
                  height: 140px;
                }
      - type: vertical-stack
        cards:
          - square: false
            type: grid
            columns: 4
            cards:
              - type: custom:button-card
                entity: select.power_sync_force_charge_duration
                show_name: true
                show_icon: true
                icon: mdi:timer-outline
                name: |-
                  [[[ return (states['select.power_sync_force_charge_duration']
                    ? states['select.power_sync_force_charge_duration'].state 
                    : '30') + ' min' ]]]
                styles:
                  card:
                    - height: 36px
                    - border-radius: 18px
                    - padding: 0px 12px
                    - background: rgba(var(--rgb-blue-color, 33, 150, 243), 0.1)
                  grid:
                    - grid-template-areas: '"i n"'
                    - grid-template-columns: 20px 1fr
                    - align-items: center
                    - padding: 2px 2px
                  icon:
                    - grid-area: i
                    - justify-self: start
                    - width: 24px
                    - height: 24px
                    - color: 'var(--green-color, #4CAF50)'
                  name:
                    - grid-area: 'n'
                    - font-size: 14px
                    - padding-left: 12px
                    - font-weight: 600
                tap_action:
                  action: more-info
              - type: custom:button-card
                name: Charge
                icon: mdi:battery-charging
                styles:
                  card:
                    - height: 36px
                    - border-radius: 18px
                    - padding: 0px 12px
                    - background: rgba(var(--rgb-blue-color, 33, 150, 243), 0.1)
                  grid:
                    - grid-template-areas: '"i n"'
                    - grid-template-columns: 20px 1fr
                    - align-items: center
                    - padding: 2px 2px
                  icon:
                    - grid-area: i
                    - justify-self: start
                    - width: 24px
                    - height: 24px
                    - color: 'var(--green-color, #4CAF50)'
                  name:
                    - grid-area: 'n'
                    - font-size: 14px
                    - padding-left: 12px
                    - font-weight: 600
                tap_action:
                  action: call-service
                  service: power_sync.force_charge
                  data:
                    duration: |-
                      [[[ return (states['select.power_sync_force_charge_duration']
                        ? states['select.power_sync_force_charge_duration'].state
                        : '30'); ]]]
                  confirmation:
                    text: >-
                      [[[ return 'Force charge for ' +
                      (states['select.power_sync_force_charge_duration']
                        ? states['select.power_sync_force_charge_duration'].state
                        : '30') + ' minutes?' ]]]
              - type: custom:button-card
                entity: select.power_sync_force_discharge_duration
                show_name: true
                show_icon: true
                icon: mdi:timer-outline
                name: |-
                  [[[ return (states['select.power_sync_force_discharge_duration']
                    ? states['select.power_sync_force_discharge_duration'].state
                    : '30') + ' min' ]]]
                styles:
                  card:
                    - height: 36px
                    - border-radius: 18px
                    - padding: 0px 12px
                    - background: rgba(var(--rgb-orange-color, 255, 152, 0), 0.1)
                  grid:
                    - grid-template-areas: '"i n"'
                    - grid-template-columns: 20px 1fr
                    - align-items: center
                    - padding: 2px 2px
                  icon:
                    - grid-area: i
                    - justify-self: start
                    - width: 24px
                    - height: 24px
                    - color: 'var(--green-color, #4CAF50)'
                  name:
                    - grid-area: 'n'
                    - font-size: 14px
                    - padding-left: 12px
                    - font-weight: 600
                tap_action:
                  action: more-info
              - type: custom:button-card
                name: Discharge
                icon: mdi:battery-arrow-down
                styles:
                  card:
                    - height: 36px
                    - border-radius: 18px
                    - padding: 0px 12px
                    - background: rgba(var(--rgb-orange-color, 255, 152, 0), 0.1)
                  grid:
                    - grid-template-areas: '"i n"'
                    - grid-template-columns: 20px 1fr
                    - align-items: center
                    - padding: 2px 2px
                  icon:
                    - grid-area: i
                    - justify-self: start
                    - width: 24px
                    - height: 24px
                    - color: 'var(--green-color, #4CAF50)'
                  name:
                    - grid-area: 'n'
                    - font-size: 12px
                    - padding-left: 12px
                    - font-weight: 600
                tap_action:
                  action: call-service
                  service: power_sync.force_discharge
                  data:
                    duration: |-
                      [[[ return (states['select.power_sync_force_discharge_duration']
                        ? states['select.power_sync_force_discharge_duration'].state
                        : '30'); ]]]
                  confirmation:
                    text: >-
                      [[[ return 'Force discharge for ' +
                      (states['select.power_sync_force_discharge_duration']
                        ? states['select.power_sync_force_discharge_duration'].state
                        : '30') + ' minutes?' ]]]
          - square: false
            type: grid
            columns: 1
            cards:
              - type: custom:button-card
                name: Restore
                icon: mdi:battery-sync
                styles:
                  card:
                    - height: 40px
                    - border-radius: 18px
                    - padding: 4px 12px
                    - background: rgba(var(--rgb-green-color, 76, 175, 80), 0.1)
                  grid:
                    - grid-template-areas: '"i n"'
                    - grid-template-columns: 24px 1fr
                  icon:
                    - grid-area: i
                    - width: 24px
                    - color: 'var(--green-color, #4CAF50)'
                  name:
                    - grid-area: 'n'
                    - text-align: left
                    - padding-left: 8px
                    - font-weight: 600
                tap_action:
                  action: call-service
                  service: power_sync.restore_normal
                  confirmation:
                    text: Restore normal battery operation?
      - type: custom:power-flow-card-plus
        entities:
          battery:
            entity: sensor.battery_power
            state_of_charge: sensor.battery_level
            name: Battery
            color_icon: true
            display_state: two_way
          grid:
            entity: sensor.grid_power
            name: Grid
            color_icon: true
            display_state: two_way
          solar:
            entity: sensor.solar_power
            name: Solar
            color_icon: true
            display_state: one_way
          home:
            entity: sensor.home_load
            name: Home
            color_icon: true
        watt_threshold: 0
        kw_decimals: 2
        min_flow_rate: 0.75
        max_flow_rate: 6
        display_zero_lines: false
        clickable_entities: true
        use_new_flow_rate_model: true
      - type: custom:apexcharts-card
        header:
          show: true
          title: Electricity Prices - 24 Hours
          show_states: false
        graph_span: 24h
        span:
          start: day
        yaxis:
          - id: price
            min: 0
            apex_config:
              tickAmount: 5
              labels:
                formatter: |
                  EVAL:function(val) {
                    return (val * 100).toFixed(0) + '¢';
                  }
        series:
          - entity: sensor.current_import_price
            name: Import
            type: line
            color: '#FF9800'
            yaxis_id: price
            stroke_width: 2
            extend_to: now
            group_by:
              func: avg
              duration: 5min
          - entity: sensor.current_export_price
            name: Export Earnings
            type: line
            color: '#4CAF50'
            yaxis_id: price
            stroke_width: 2
            extend_to: now
            group_by:
              func: avg
              duration: 5min
        apex_config:
          chart:
            height: 200
          stroke:
            curve: smooth
          legend:
            show: true
            position: bottom
          tooltip:
            x:
              format: HH:mm
            'y':
              formatter: |
                EVAL:function(value) {
                  if (value === null || value === undefined) return '';
                  const cents = value * 100;
                  if (Math.abs(cents) >= 1000) {
                    return '$' + value.toFixed(2);
                  }
                  return cents.toFixed(0) + '¢';
                }
      - type: custom:apexcharts-card
        header:
          show: true
          title: TOU Schedule
          show_states: false
        graph_span: 24h
        span:
          start: day
        yaxis:
          - id: price
            min: 0
            apex_config:
              tickAmount: 5
              labels:
                formatter: |
                  EVAL:function(val) {
                    return val.toFixed(0) + '¢';
                  }
        series:
          - entity: sensor.tariff_schedule
            name: Buy Price
            type: line
            color: '#FF9800'
            yaxis_id: price
            stroke_width: 2
            curve: stepline
            extend_to: end
            data_generator: |
              const now = new Date();

              const today = new Date(now.getFullYear(), now.getMonth(),
              now.getDate());

              const currentDow = now.getDay();

              let data = [];


              // Amber format: schedule with time-based entries

              const schedule = entity?.attributes?.schedule || [];

              if (schedule.length > 0) {
                data = schedule.map((entry) => {
                  const [hours, mins] = String(entry.time).split(':').map(Number);
                  const timestamp = new Date(today.getTime() + hours * 3600000 + mins * 60000);
                  return [timestamp.getTime(), entry.buy];
                });
                if (data.length > 0) {
                  const endOfDay = new Date(today.getTime() + 24 * 3600000 - 1);
                  data.push([endOfDay.getTime(), data[data.length - 1][1]]);
                }
                return data;
              }
              const touSchedule = entity?.attributes?.tou_schedule || [];

              if (touSchedule.length > 0) {
                const hourlyPrices = new Array(24).fill(null);
                touSchedule.forEach((period) => {
                  const windows = period.windows || [];
                  windows.forEach((w) => {
                    if (currentDow >= w.from_day && currentDow <= w.to_day) {
                      const fromHour = w.from_hour || 0;
                      const toHour = w.to_hour || 24;
                      if (fromHour <= toHour) {
                        for (let h = fromHour; h < toHour && h < 24; h++) {
                          hourlyPrices[h] = period.buy;
                        }
                      } else {
                        for (let h = fromHour; h < 24; h++) hourlyPrices[h] = period.buy;
                        for (let h = 0; h < toHour; h++) hourlyPrices[h] = period.buy;
                      }
                    }
                  });
                });
                const defaultPrice = entity?.attributes?.buy_price || touSchedule[0]?.buy || 0;
                for (let h = 0; h < 24; h++) {
                  if (hourlyPrices[h] === null) hourlyPrices[h] = defaultPrice;
                  const timestamp = new Date(today.getTime() + h * 3600000);
                  data.push([timestamp.getTime(), hourlyPrices[h]]);
                }
                const endOfDay = new Date(today.getTime() + 24 * 3600000 - 1);
                data.push([endOfDay.getTime(), hourlyPrices[23]]);
                return data;
              }


              // Fallback: use current buy_price as flat line

              const buyPrice = entity?.attributes?.buy_price;

              if (buyPrice !== undefined) {
                return [
                  [today.getTime(), buyPrice],
                  [new Date(today.getTime() + 24 * 3600000 - 1).getTime(), buyPrice]
                ];
              }

              return [];
          - entity: sensor.tariff_schedule
            name: Sell Price
            type: line
            color: '#4CAF50'
            yaxis_id: price
            stroke_width: 2
            curve: stepline
            extend_to: end
            data_generator: |
              const now = new Date();

              const today = new Date(now.getFullYear(), now.getMonth(),
              now.getDate());

              const currentDow = now.getDay();

              let data = [];


              // Amber format: schedule with time-based entries

              const schedule = entity?.attributes?.schedule || [];

              if (schedule.length > 0) {
                data = schedule.map((entry) => {
                  const [hours, mins] = String(entry.time).split(':').map(Number);
                  const timestamp = new Date(today.getTime() + hours * 3600000 + mins * 60000);
                  return [timestamp.getTime(), entry.sell];
                });
                if (data.length > 0) {
                  const endOfDay = new Date(today.getTime() + 24 * 3600000 - 1);
                  data.push([endOfDay.getTime(), data[data.length - 1][1]]);
                }
                return data;
              }
              const touSchedule = entity?.attributes?.tou_schedule || [];

              if (touSchedule.length > 0) {
                const hourlyPrices = new Array(24).fill(null);
                touSchedule.forEach((period) => {
                  const windows = period.windows || [];
                  windows.forEach((w) => {
                    if (currentDow >= w.from_day && currentDow <= w.to_day) {
                      const fromHour = w.from_hour || 0;
                      const toHour = w.to_hour || 24;
                      if (fromHour <= toHour) {
                        for (let h = fromHour; h < toHour && h < 24; h++) {
                          hourlyPrices[h] = period.sell;
                        }
                      } else {
                        for (let h = fromHour; h < 24; h++) hourlyPrices[h] = period.sell;
                        for (let h = 0; h < toHour; h++) hourlyPrices[h] = period.sell;
                      }
                    }
                  });
                });
                const defaultPrice = entity?.attributes?.sell_price || touSchedule[0]?.sell || 0;
                for (let h = 0; h < 24; h++) {
                  if (hourlyPrices[h] === null) hourlyPrices[h] = defaultPrice;
                  const timestamp = new Date(today.getTime() + h * 3600000);
                  data.push([timestamp.getTime(), hourlyPrices[h]]);
                }
                const endOfDay = new Date(today.getTime() + 24 * 3600000 - 1);
                data.push([endOfDay.getTime(), hourlyPrices[23]]);
                return data;
              }


              // Fallback: use current sell_price as flat line

              const sellPrice = entity?.attributes?.sell_price;

              if (sellPrice !== undefined) {
                return [
                  [today.getTime(), sellPrice],
                  [new Date(today.getTime() + 24 * 3600000 - 1).getTime(), sellPrice]
                ];
              }

              return [];
        apex_config:
          chart:
            height: 200
          stroke:
            curve: stepline
          legend:
            show: true
            position: bottom
          tooltip:
            x:
              format: HH:mm
            'y':
              formatter: |
                EVAL:function(value) {
                  if (value === null || value === undefined) return '';
                  if (Math.abs(value) >= 100) {
                    return '$' + (value / 100).toFixed(2);
                  }
                  return value.toFixed(1) + '¢';
                }
      - type: horizontal-stack
        cards:
          - type: custom:button-card
            entity: sensor.dc_solar_curtailment
            name: DC Solar (Tesla)
            show_icon: true
            show_name: true
            show_label: true
            label: |-
              [[[
                const state = states['sensor.dc_solar_curtailment']?.state;
                if (state === 'Active') return 'CURTAILED - Export blocked';
                return 'Normal - Export allowed';
              ]]]
            icon: |-
              [[[
                const state = states['sensor.dc_solar_curtailment']?.state;
                return state === 'Active'
                  ? 'mdi:solar-power-variant-outline'
                  : 'mdi:solar-power-variant';
              ]]]
            styles:
              card:
                - border-radius: 16px
                - padding: 12px
                - background: |-
                    [[[
                      const state = states['sensor.dc_solar_curtailment']?.state;
                      return state === 'Active'
                        ? 'linear-gradient(135deg, rgba(244, 67, 54, 0.15) 0%, rgba(244, 67, 54, 0.05) 100%)'
                        : 'linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.05) 100%)';
                    ]]]
              grid:
                - grid-template-areas: '"i n" "i l"'
                - grid-template-columns: min-content 1fr
                - column-gap: 10px
                - row-gap: 2px
                - align-items: center
              icon:
                - width: 28px
                - color: |-
                    [[[
                      const state = states['sensor.dc_solar_curtailment']?.state;
                      return state === 'Active' ? 'var(--red-color)' : 'var(--green-color)';
                    ]]]
              name:
                - justify-self: start
                - font-weight: 700
                - font-size: 16px
              label:
                - justify-self: start
                - opacity: 0.85
                - font-size: 14px
            tap_action:
              action: more-info
          - type: custom:button-card
            entity: sensor.inverter_status
            name: AC Inverter
            show_icon: true
            show_name: true
            show_label: true
            label: |-
              [[[
                const stateObj = states['sensor.inverter_status'];
                const raw = (stateObj?.state ?? 'unknown').toLowerCase();
                const power = stateObj?.attributes?.power_limit_percent;
                const powerW = Number(stateObj?.attributes?.power_output_w ?? 0);
                const brand = stateObj?.attributes?.brand;
                const running = (stateObj?.attributes?.running_state ?? '').toLowerCase();
                const isNight = states['sun.sun']?.state === 'below_horizon';
                const isSleep = isNight && ((powerW < 100) || (running === 'stopped')) && !['offline','error','unavailable','unknown'].includes(raw);
                const state = isSleep ? 'sleep' : raw;

                if (state === 'unavailable' || state === 'unknown') return 'Not configured';
                if (state === 'curtailed') return `CURTAILED${power ? ` - ${power}%` : ''}`;
                if (state === 'sleep') return `Sleep${powerW > 0 ? ' (PID recovery)' : ''}`;
                if (state === 'offline') return 'Offline - Cannot reach';
                if (state === 'error') return 'Error - Check logs';

                const title = brand ? (brand.charAt(0).toUpperCase() + brand.slice(1)) : 'Online';
                if (powerW) return `${title} - ${Math.round(powerW)}W`;
                if (power) return `${title} - ${power}%`;
                return title;
              ]]]
            icon: |-
              [[[
                const raw = (states['sensor.inverter_status']?.state ?? 'unknown').toLowerCase();
                const powerW = Number(states['sensor.inverter_status']?.attributes?.power_output_w ?? 0);
                const running = (states['sensor.inverter_status']?.attributes?.running_state ?? '').toLowerCase();
                const isNight = states['sun.sun']?.state === 'below_horizon';
                const isSleep = isNight && ((powerW < 100) || (running === 'stopped')) && !['offline','error','unavailable','unknown'].includes(raw);
                if (isSleep) return 'mdi:moon-waning-crescent';
                if (raw === 'error') return 'mdi:alert-octagon';
                return 'mdi:solar-panel';
              ]]]
            styles:
              card:
                - border-radius: 16px
                - padding: 12px
                - background: |-
                    [[[
                      const stateObj = states['sensor.inverter_status'];
                      const raw = (stateObj?.state ?? 'unknown').toLowerCase();
                      const powerW = Number(stateObj?.attributes?.power_output_w ?? 0);
                      const running = (stateObj?.attributes?.running_state ?? '').toLowerCase();
                      const isNight = states['sun.sun']?.state === 'below_horizon';
                      const isSleep = isNight && ((powerW < 100) || (running === 'stopped')) && !['offline','error','unavailable','unknown'].includes(raw);
                      const state = isSleep ? 'sleep' : raw;

                      if (state === 'curtailed') return 'linear-gradient(135deg, rgba(244, 67, 54, 0.15) 0%, rgba(244, 67, 54, 0.05) 100%)';
                      if (state === 'sleep') return 'linear-gradient(135deg, rgba(96, 125, 139, 0.15) 0%, rgba(96, 125, 139, 0.05) 100%)';
                      if (state === 'offline' || state === 'error') return 'linear-gradient(135deg, rgba(255, 152, 0, 0.15) 0%, rgba(255, 152, 0, 0.05) 100%)';
                      if (state === 'unavailable' || state === 'unknown') return 'linear-gradient(135deg, rgba(158, 158, 158, 0.10) 0%, rgba(158, 158, 158, 0.05) 100%)';
                      return 'linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.05) 100%)';
                    ]]]
              grid:
                - grid-template-areas: '"i n" "i l"'
                - grid-template-columns: min-content 1fr
                - column-gap: 10px
                - row-gap: 2px
                - align-items: center
              icon:
                - width: 28px
                - color: |-
                    [[[
                      const raw = (states['sensor.inverter_status']?.state ?? 'unknown').toLowerCase();
                      const powerW = Number(states['sensor.inverter_status']?.attributes?.power_output_w ?? 0);
                      const running = (states['sensor.inverter_status']?.attributes?.running_state ?? '').toLowerCase();
                      const isNight = states['sun.sun']?.state === 'below_horizon';
                      const isSleep = isNight && ((powerW < 100) || (running === 'stopped')) && !['offline','error','unavailable','unknown'].includes(raw);
                      const state = isSleep ? 'sleep' : raw;

                      if (state === 'curtailed') return 'var(--red-color)';
                      if (state === 'sleep') return 'var(--blue-grey-color)';
                      if (state === 'offline' || state === 'error') return 'var(--orange-color)';
                      if (state === 'unavailable' || state === 'unknown') return 'var(--disabled-text-color)';
                      return 'var(--green-color)';
                    ]]]
              name:
                - justify-self: start
                - font-weight: 700
                - font-size: 16px
              label:
                - justify-self: start
                - opacity: 0.85
                - font-size: 14px
            tap_action:
              action: more-info
            card_mod:
              style: |
                ha-card {
                  {% set raw_state = states('sensor.inverter_status') | lower %}
                  {% set power_w = state_attr('sensor.inverter_status', 'power_output_w') | float(0) %}
                  {% set running = state_attr('sensor.inverter_status', 'running_state') | default('') | lower %}
                  {% set is_night = states('sun.sun') == 'below_horizon' %}
                  {% set is_sleep = is_night and (power_w < 100 or running == 'stopped') and raw_state not in ['offline', 'error', 'unavailable', 'unknown'] %}
                  {% set state = 'sleep' if is_sleep else raw_state %}
                  {% if state == 'curtailed' %}
                  background: linear-gradient(135deg, rgba(244, 67, 54, 0.15) 0%, rgba(244, 67, 54, 0.05) 100%);
                  {% elif state == 'sleep' %}
                  background: linear-gradient(135deg, rgba(96, 125, 139, 0.15) 0%, rgba(96, 125, 139, 0.05) 100%);
                  {% elif state == 'offline' or state == 'error' %}
                  background: linear-gradient(135deg, rgba(255, 152, 0, 0.15) 0%, rgba(255, 152, 0, 0.05) 100%);
                  {% elif state == 'unavailable' or state == 'unknown' %}
                  background: linear-gradient(135deg, rgba(158, 158, 158, 0.1) 0%, rgba(158, 158, 158, 0.05) 100%);
                  {% else %}
                  background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.05) 100%);
                  {% endif %}
                }
      - type: conditional
        conditions:
          - condition: state
            entity: sensor.inverter_status
            state_not: unavailable
          - condition: state
            entity: sensor.inverter_status
            state_not: unknown
        card:
          type: grid
          columns: 3
          square: false
          cards:
            - type: custom:button-card
              name: Load Follow
              icon: mdi:home-lightning-bolt
              styles:
                card:
                  - height: 40px
                  - border-radius: 18px
                  - padding: 0px 12px
                  - background: rgba(var(--rgb-orange-color, 255, 152, 0), 0.12)
                grid:
                  - grid-template-areas: '"i n"'
                  - grid-template-columns: min-content auto
                icon:
                  - color: 'var(--orange-color, #FF9800)'
                  - width: 20px
                name:
                  - font-size: 12px
                  - font-weight: 600
                  - white-space: nowrap
              tap_action:
                action: call-service
                service: power_sync.curtail_inverter
                data:
                  mode: load_following
                confirmation:
                  text: Limit inverter to home load only?
            - type: custom:button-card
              name: Shutdown
              icon: mdi:power-plug-off
              styles:
                card:
                  - height: 40px
                  - border-radius: 18px
                  - padding: 0px 12px
                  - background: rgba(var(--rgb-red-color, 244, 67, 54), 0.12)
                grid:
                  - grid-template-areas: '"i n"'
                  - grid-template-columns: min-content auto
                icon:
                  - color: 'var(--red-color, #F44336)'
                  - width: 20px
                name:
                  - font-size: 12px
                  - font-weight: 600
                  - white-space: nowrap
              tap_action:
                action: call-service
                service: power_sync.curtail_inverter
                data:
                  mode: shutdown
                confirmation:
                  text: Fully shut down inverter (0% output)?
            - type: custom:button-card
              name: Restore
              icon: mdi:power-plug
              styles:
                card:
                  - height: 40px
                  - border-radius: 18px
                  - padding: 0px 12px
                  - background: rgba(var(--rgb-green-color, 76, 175, 80), 0.12)
                grid:
                  - grid-template-areas: '"i n"'
                  - grid-template-columns: min-content auto
                icon:
                  - color: 'var(--green-color, #4CAF50)'
                  - width: 20px
                name:
                  - font-size: 12px
                  - font-weight: 600
                  - white-space: nowrap
              tap_action:
                action: call-service
                service: power_sync.restore_inverter
                confirmation:
                  text: Restore inverter to normal operation?
      - type: vertical-stack
        cards:
          - type: custom:button-card
            name: Battery Health
            show_icon: false
            show_name: true
            styles:
              card:
                - height: 36px
                - border-radius: 12px
                - padding: 0px 12px
                - background: rgba(var(--rgb-primary-color, 3, 169, 244), 0.10)
              name:
                - justify-self: start
                - font-weight: 800
                - font-size: 14px
                - letter-spacing: 0.5px
          - type: grid
            columns: 4
            square: false
            cards:
              - type: custom:button-card
                entity: sensor.battery_health
                name: Overall
                show_icon: false
                show_name: true
                show_state: true
                state_display: |-
                  [[[
                    const v = states['sensor.battery_health']?.state;
                    if (!v || ['unknown','unavailable','none'].includes(String(v).toLowerCase())) return '';
                    const n = Number(v);
                    if (!Number.isFinite(n)) return '';
                    return `${n.toFixed(1)} %`;
                  ]]]
                styles:
                  card:
                    - height: 90px
                    - border-radius: 12px
                    - padding: 10px
                    - display: |-
                        [[[
                          const v = states['sensor.battery_health']?.state;
                          if (!v || ['unknown','unavailable','none'].includes(String(v).toLowerCase())) return 'none';
                          const n = Number(v);
                          return Number.isFinite(n) ? 'block' : 'none';
                        ]]]
                  name:
                    - font-weight: 700
                    - font-size: 13px
                  state:
                    - font-size: 22px
                    - font-weight: 800
                    - margin-top: 6px
              - type: custom:button-card
                entity: sensor.battery_health
                name: Battery 1
                show_icon: false
                show_name: true
                show_state: true
                state_display: |-
                  [[[
                    const v = states['sensor.battery_health']?.attributes?.battery_1_health_percent;
                    if (v === undefined || v === null) return '';
                    const n = Number(v);
                    if (!Number.isFinite(n)) return '';
                    return `${n.toFixed(1)} %`;
                  ]]]
                styles:
                  card:
                    - height: 90px
                    - border-radius: 12px
                    - padding: 10px
                    - display: |-
                        [[[
                          const v = states['sensor.battery_health']?.attributes?.battery_1_health_percent;
                          if (v === undefined || v === null) return 'none';
                          const n = Number(v);
                          return Number.isFinite(n) ? 'block' : 'none';
                        ]]]
                  name:
                    - font-weight: 700
                    - font-size: 13px
                  state:
                    - font-size: 22px
                    - font-weight: 800
                    - margin-top: 6px
              - type: custom:button-card
                entity: sensor.battery_health
                name: Battery 2
                show_icon: false
                show_name: true
                show_state: true
                state_display: |-
                  [[[
                    const v = states['sensor.battery_health']?.attributes?.battery_2_health_percent;
                    if (v === undefined || v === null) return '';
                    const n = Number(v);
                    if (!Number.isFinite(n)) return '';
                    return `${n.toFixed(1)} %`;
                  ]]]
                styles:
                  card:
                    - height: 90px
                    - border-radius: 12px
                    - padding: 10px
                    - display: |-
                        [[[
                          const v = states['sensor.battery_health']?.attributes?.battery_2_health_percent;
                          if (v === undefined || v === null) return 'none';
                          const n = Number(v);
                          return Number.isFinite(n) ? 'block' : 'none';
                        ]]]
                  name:
                    - font-weight: 700
                    - font-size: 13px
                  state:
                    - font-size: 22px
                    - font-weight: 800
                    - margin-top: 6px
              - type: custom:button-card
                entity: sensor.battery_health
                name: Battery 3
                show_icon: false
                show_name: true
                show_state: true
                state_display: |-
                  [[[
                    const v = states['sensor.battery_health']?.attributes?.battery_3_health_percent;
                    if (v === undefined || v === null) return '';
                    const n = Number(v);
                    if (!Number.isFinite(n)) return '';
                    return `${n.toFixed(1)} %`;
                  ]]]
                styles:
                  card:
                    - height: 90px
                    - border-radius: 12px
                    - padding: 10px
                    - display: |-
                        [[[
                          const v = states['sensor.battery_health']?.attributes?.battery_3_health_percent;
                          if (v === undefined || v === null) return 'none';
                          const n = Number(v);
                          return Number.isFinite(n) ? 'block' : 'none';
                        ]]]
                  name:
                    - font-weight: 700
                    - font-size: 13px
                  state:
                    - font-size: 22px
                    - font-weight: 800
                    - margin-top: 6px
          - type: markdown
            content: >
              {% set original = state_attr('sensor.battery_health',
              'original_capacity_kwh') %}

              {% set current = state_attr('sensor.battery_health',
              'current_capacity_kwh') %}

              {% set scan = state_attr('sensor.battery_health', 'last_scan') %}

              {%- if states('sensor.battery_health') not in ['unavailable',
              'unknown'] %}

              **Capacity:** {{ current }} / {{ original }} kWh | **Last scan:**
              {{ scan[:10] if scan else 'N/A' }}

              {%- else %}

              Scan from the PowerSync Mobile app while connected to Powerwall
              WiFi.

              {%- endif %}
      - type: custom:apexcharts-card
        header:
          show: true
          title: Solar
          show_states: true
        graph_span: 24h
        span:
          start: day
        series:
          - entity: sensor.solar_power
            name: Solar
            type: area
            color: '#FFD700'
            stroke_width: 2
            extend_to: now
            group_by:
              func: avg
              duration: 5min
        apex_config:
          chart:
            height: 150
          yaxis:
            min: 0
      - type: custom:apexcharts-card
        header:
          show: true
          title: Battery
          show_states: true
        graph_span: 24h
        span:
          start: day
        series:
          - entity: sensor.battery_power
            name: Battery
            type: area
            color: '#2196F3'
            stroke_width: 2
            extend_to: now
            group_by:
              func: avg
              duration: 5min
        apex_config:
          chart:
            height: 150
      - type: custom:apexcharts-card
        header:
          show: true
          title: Grid
          show_states: true
        graph_span: 24h
        span:
          start: day
        series:
          - entity: sensor.grid_power
            name: Grid
            type: area
            color: '#F44336'
            stroke_width: 2
            extend_to: now
            group_by:
              func: avg
              duration: 5min
        apex_config:
          chart:
            height: 150
      - type: custom:apexcharts-card
        header:
          show: true
          title: Home
          show_states: true
        graph_span: 24h
        span:
          start: day
        series:
          - entity: sensor.home_load
            name: Home
            type: area
            color: '#9C27B0'
            stroke_width: 2
            extend_to: now
            group_by:
              func: avg
              duration: 5min
        apex_config:
          chart:
            height: 150
          yaxis:
            min: 0
