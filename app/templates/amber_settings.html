{% extends "settings_base.html" %}

{% block settings_content %}
    <hgroup>
        <h1>Amber Electric Settings</h1>
        <h2>Configure Amber-specific TOU tariff options</h2>
    </hgroup>

    <article>
        <header><strong>Amber Electric Configuration</strong></header>
        <p>These settings control how Amber Electric pricing forecasts are used for your TOU tariff sync.</p>

        <form action="{{ url_for('main.amber_settings') }}" method="post" novalidate>
            {{ form.hidden_tag() }}

            {% if amber_sites %}
            <fieldset>
                <legend>Amber Site</legend>
                {% if amber_sites|length == 1 %}
                    {# Include hidden field so form validation passes #}
                    <input type="hidden" name="amber_site_id" value="{{ amber_sites[0]['id'] }}">
                    <label>
                        <strong>Your Amber Site:</strong> {{ amber_sites[0].get('nmi', amber_sites[0]['id']) }}
                        <small style="display: block; margin-top: 0.3em; color: var(--muted-color);">Only one site found - auto-selected</small>
                    </label>
                {% else %}
                    <label for="amber_site_id">
                        {{ form.amber_site_id.label }}
                        {{ form.amber_site_id(style="width: 100%;") }}
                        <small>{{ form.amber_site_id.description }}</small>
                    </label>
                {% endif %}
            </fieldset>
            {% endif %}

            <fieldset>
                <legend>Forecast Pricing Type</legend>
                <label for="amber_forecast_type">
                    {{ form.amber_forecast_type.label }}
                    {{ form.amber_forecast_type(style="width: 100%;") }}
                    <small>{{ form.amber_forecast_type.description }}</small>
                </label>
                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">What do these options mean?</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 150, 200, 0.05); border-radius: 0.3em;">
                        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.5em 0;"><strong>Predicted (Default):</strong> Uses Amber's best estimate for upcoming prices. Balanced approach.</li>
                            <li style="margin: 0.5em 0;"><strong>Low (Conservative):</strong> Uses the low-end forecast. Battery may charge more conservatively and discharge less aggressively.</li>
                            <li style="margin: 0.5em 0;"><strong>High (Optimistic):</strong> Uses the high-end forecast. Battery may charge more aggressively during predicted low prices and export more during predicted high prices.</li>
                        </ul>
                    </div>
                </details>
            </fieldset>

            <fieldset>
                <legend>Solar Curtailment</legend>
                <label for="solar_curtailment_enabled">
                    {{ form.solar_curtailment_enabled() }}
                    {{ form.solar_curtailment_enabled.label }}
                    <small>{{ form.solar_curtailment_enabled.description }}</small>
                </label>
                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">How does solar curtailment work?</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 150, 200, 0.05); border-radius: 0.3em;">
                        <p style="margin: 0.3em 0;">When enabled, this feature monitors Amber feed-in prices every minute and automatically:</p>
                        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.5em 0;"><strong>During negative prices (≤0c/kWh):</strong> Sets Powerwall export to "never" to prevent paying to export your solar to the grid.</li>
                            <li style="margin: 0.5em 0;"><strong>During positive prices (>0c/kWh):</strong> Restores export to "battery_ok" to allow both solar and battery export.</li>
                        </ul>
                        <p style="margin: 0.5em 0 0 0; font-style: italic;">This is particularly useful with Amber's wholesale pricing to avoid financial penalties during negative price events.</p>
                    </div>
                </details>
            </fieldset>

            <fieldset>
                <legend>Export Price Boost</legend>
                <p style="font-size: 0.85em; margin: 0 0 1em 0; color: var(--muted-color);">
                    Artificially increase export prices to trigger Powerwall exports. Useful when prices are in the 20-25c range where Tesla may not export.
                </p>

                <label for="export_boost_enabled" style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
                    <input type="checkbox" id="export_boost_enabled" name="export_boost_enabled"
                           {% if current_user.export_boost_enabled %}checked{% endif %}
                           onchange="toggleExportBoostDetails()">
                    <span>Enable Export Price Boost</span>
                </label>

                <div id="exportBoostDetails" style="margin-top: 1em; {% if not current_user.export_boost_enabled %}display: none;{% endif %}">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em;">
                        <label for="export_price_offset">
                            Price Offset (c/kWh)
                            <small>Added to all export prices</small>
                            <input type="number" id="export_price_offset" name="export_price_offset"
                                   value="{{ current_user.export_price_offset or 0 }}"
                                   step="0.1" min="0" max="50"
                                   style="width: 100%;">
                        </label>

                        <label for="export_min_price">
                            Minimum Price (c/kWh)
                            <small>Floor for export prices</small>
                            <input type="number" id="export_min_price" name="export_min_price"
                                   value="{{ current_user.export_min_price or 0 }}"
                                   step="0.1" min="0" max="100"
                                   style="width: 100%;">
                        </label>
                    </div>

                    <div style="margin-top: 1em;">
                        <label for="export_boost_threshold">
                            Activation Threshold (c/kWh)
                            <small>Boost won't apply if actual price is below this (0 = always apply)</small>
                            <input type="number" id="export_boost_threshold" name="export_boost_threshold"
                                   value="{{ current_user.export_boost_threshold or 0 }}"
                                   step="0.1" min="0" max="50"
                                   style="width: 100%;">
                        </label>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-top: 1em;">
                        <label for="export_boost_start">
                            Boost Start Time
                            <small>When to start applying boost</small>
                            <input type="time" id="export_boost_start" name="export_boost_start"
                                   value="{{ current_user.export_boost_start or '17:00' }}"
                                   style="width: 100%;">
                        </label>

                        <label for="export_boost_end">
                            Boost End Time
                            <small>When to stop applying boost</small>
                            <input type="time" id="export_boost_end" name="export_boost_end"
                                   value="{{ current_user.export_boost_end or '21:00' }}"
                                   style="width: 100%;">
                        </label>
                    </div>

                    <p style="font-size: 0.75em; margin: 1em 0 0 0; color: var(--muted-color);">
                        Example: With offset=5c, min=20c, threshold=10c: an 18c export becomes 23c (18+5). A 12c export becomes 20c (floor). A 5c export stays at 5c (below threshold, boost skipped).
                    </p>
                </div>
                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">When should I use this?</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 150, 200, 0.05); border-radius: 0.3em;">
                        <p style="margin: 0.3em 0;">Tesla Powerwalls may not export when prices are below ~25c/kWh. This feature boosts prices sent to Tesla to trigger exports during peak periods.</p>
                        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.5em 0;"><strong>Price Offset:</strong> Adds this amount to all export prices (e.g., +5c makes 20c appear as 25c to Tesla)</li>
                            <li style="margin: 0.5em 0;"><strong>Minimum Price:</strong> Sets a floor price (e.g., 20c minimum ensures prices never appear lower)</li>
                            <li style="margin: 0.5em 0;"><strong>Activation Threshold:</strong> Boost only applies if actual price is at or above this value (e.g., 10c threshold skips boost for very low/negative prices)</li>
                            <li style="margin: 0.5em 0;"><strong>Time Window:</strong> Only applies boost during these hours (typically peak export times)</li>
                        </ul>
                    </div>
                </details>
            </fieldset>

            <div style="margin-top: 1.5em;">
                {{ form.submit(style="width: 100%;") }}
            </div>
        </form>
    </article>

    <!-- Information Box -->
    <article style="margin-top: 1.5em; background: rgba(100, 150, 200, 0.05); border-left: 4px solid var(--primary);">
        <header><strong>ℹ️ About These Settings</strong></header>
        <p style="font-size: 0.9em; margin: 0;">These settings only affect the TOU tariff that gets synced to your Tesla Powerwall. Changes will take effect on the next automatic sync (every 5 minutes).</p>
        <p style="font-size: 0.9em; margin: 0.5em 0 0 0;">You can test different forecast types to see which strategy works best for your usage patterns and preferences.</p>
    </article>

    <script>
        function toggleExportBoostDetails() {
            const enabled = document.getElementById('export_boost_enabled').checked;
            const details = document.getElementById('exportBoostDetails');
            if (details) {
                details.style.display = enabled ? 'block' : 'none';
            }
        }
    </script>
{% endblock %}
